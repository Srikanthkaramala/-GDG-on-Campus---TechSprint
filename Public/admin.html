<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Campus Voice</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { color: #1a73e8; margin: 0; }
        .refresh-btn { background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .refresh-btn:hover { background: #1557b0; }

        /* Charts Section */
        .charts-row { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .chart-card { flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 300px; }
        
        /* Feedback List */
        .list-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #444; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
        
        .feedback-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 15px 0; }
        .feedback-item:last-child { border-bottom: none; }
        .meta { width: 150px; font-size: 0.85rem; color: #666; }
        .content { flex: 1; margin: 0 20px; }
        .summary { font-weight: bold; color: #333; display: block; margin-bottom: 4px; }
        .text { color: #555; font-size: 0.9rem; }
        
        /* Badges for Sentiment */
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge.Negative { background: #fce8e6; color: #c5221f; }
        .badge.Positive { background: #e6f4ea; color: #137333; }
        .badge.Neutral { background: #f1f3f4; color: #5f6368; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ðŸ“Š Admin Analytics</h1>
        <button class="refresh-btn" onclick="location.reload()">ðŸ”„ Refresh Data</button>
    </header>

    <div class="charts-row">
        <div class="chart-card" id="sentiment_chart">Loading Chart...</div>
        <div class="chart-card" id="category_chart">Loading Chart...</div>
    </div>

    <div class="list-card">
        <h2>Recent Student Feedback</h2>
        <div id="feedback-list">Loading data...</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // --- YOUR KEYS (Already Inserted) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCqlRYCpVBSbAM2t2bU8IKaHQqxxCHoHX0",
        authDomain: "studentfeedback-mbu.firebaseapp.com",
        projectId: "studentfeedback-mbu",
        storageBucket: "studentfeedback-mbu.firebasestorage.app",
        messagingSenderId: "138139095564",
        appId: "1:138139095564:web:342a751973469c35bad429",
        measurementId: "G-7Y55G2WSCK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Load Google Charts
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(fetchData);

    async function fetchData() {
        const listDiv = document.getElementById("feedback-list");
        listDiv.innerHTML = "Fetching latest data...";

        // 1. Get Data from Firestore
        const q = query(collection(db, "feedback"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);

        // Data arrays for Charts
        let sentimentCounts = { "Positive": 0, "Negative": 0, "Neutral": 0 };
        let categoryCounts = {};
        
        let html = "";

        querySnapshot.forEach((doc) => {
            const data = doc.data();
            
            // Count for Sentiment Chart
            const sentiment = data.ai_sentiment || "Neutral";
            if (sentimentCounts[sentiment] !== undefined) {
                sentimentCounts[sentiment]++;
            } else {
                sentimentCounts["Neutral"]++; // Catch weird values
            }

            // Count for Category Chart
            const cat = data.category || "Other";
            categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;

            // Add to List HTML
            html += `
                <div class="feedback-item">
                    <div class="meta">
                        ${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : 'Just now'}<br>
                        <strong>${data.category}</strong>
                    </div>
                    <div class="content">
                        <span class="summary">AI Summary: "${data.ai_summary || 'Processing...'}"</span>
                        <span class="text">"${data.message}"</span>
                    </div>
                    <div>
                        <span class="badge ${sentiment}">${sentiment}</span>
                    </div>
                </div>
            `;
        });

        listDiv.innerHTML = html || "<p>No feedback found yet.</p>";

        // 2. Draw Charts
        drawSentimentChart(sentimentCounts);
        drawCategoryChart(categoryCounts);
    }

    function drawSentimentChart(counts) {
        var data = google.visualization.arrayToDataTable([
            ['Sentiment', 'Count'],
            ['Positive', counts.Positive],
            ['Negative', counts.Negative],
            ['Neutral', counts.Neutral]
        ]);

        var options = { title: 'AI Sentiment Analysis', pieHole: 0.4, colors: ['#0f9d58', '#db4437', '#757575'] };
        var chart = new google.visualization.PieChart(document.getElementById('sentiment_chart'));
        chart.draw(data, options);
    }

    function drawCategoryChart(counts) {
        // Convert object to array
        let chartArray = [['Category', 'Count']];
        for (const [key, value] of Object.entries(counts)) {
            chartArray.push([key, value]);
        }

        var data = google.visualization.arrayToDataTable(chartArray);
        var options = { title: 'Issues by Category', pieHole: 0.4 };
        var chart = new google.visualization.PieChart(document.getElementById('category_chart'));
        chart.draw(data, options);
    }
</script>

</body>
</html>